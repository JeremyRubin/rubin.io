<!DOCTYPE html>
<html lang="en-us">
    <head>
  <title> Epoch Mempool &middot; Jeremy Rubin </title>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">


  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/font-awesome-4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <link type="application/atom+xml" rel="alternate" href="http://rubin.io/feed.xml" title="Jeremy Rubin" />


  <!-- GA -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-40376251-1', 'auto');
    ga('send', 'pageview');
</script>

  
  <link rel="me" href="https://twitter.com/JeremyRubin" >
  <meta name="twitter:dnt" content="on">
			   <script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

</head>

    <body>
        <div class="sidebar">
    <h3 style="text-align: center;"> <a href="/"> Jeremy Rubin </a> </h3>
    <div class="container">
        <div class="sidebar-about">

            <div class="sidebar-about-info"> 
                <a href="/public/pdfs/resume.pdf"><i class="fa fa-file-text-o" title=Resume></i></a>
                <a href=""><i class="fa fa-github" title=Github></i></a>
                <a href="https://twitter.com/JeremyRubin"><i class="fa fa-twitter" title=Twitter></i></a>
            </div>
            <div class="sidebar-about-info hide-large">
                <a class="" href="/">Home</a>
                <a class="" href="/blog/">Blog</a>
                <a class="" href="/talks/">Talks</a> 
                <a class="" href="/projects/">Projects</a>
                <a class="" href="/archive/">Site Index</a>
            </div>
        </div>




        <nav class="sidebar-nav hide-small">
            <a class="sidebar-nav-item" href="/">Home</a>
            <a class="sidebar-nav-item" href="/blog/">Blog</a>
            <a class="sidebar-nav-item" href="/talks/">Talks</a> 
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
            <a class="sidebar-nav-item" href="/archive/">Site Index</a>
        </nav>
    </div>
</div>



        <div class="content container" style="padding-bottom:0;">
            <div class="post">
    <h1 class="post-title">Epoch Mempool</h1>
    <h3>Hansel and Gretel, left bread crumb trails as they went, but birds ate them all.</h3>
    <span class="post-date">October 26, 2019</span>
    <p class="center-image rounded"><a href="https://github.com/bitcoin/bitcoin/pull/17268"><img src="/public/img/epoch.png" alt="Tx Graph" /></a></p>

<p>The Epoch Mempool is a project to improve the asymptotic complexity of many of
the mempool’s algorithms as well as makes them more performant in practice.</p>

<p>In the mempool we have a lot of algorithms which depend on rather
computationally expensive state tracking. The state tracking algorithms we use
make a lot of algorithms inefficient because we’re inserting into various sets
that grow with the number of ancestors and descendants, or we may have to
iterate multiple times of data we’ve already seen.</p>

<p>To address these inefficiencies, we can closely limit the maximum possible data
we iterate and reject transactions above the limits.</p>

<p>However, a rational miner/user will purchase faster hardware and raise these
limits to be able to collect more fee revenue or process more transactions.
Further, changes coming from around the ecosystem (lightning, OP_SECURETHEBAG)
have critical use cases which benefit when the mempool has fewer limitations.</p>

<p>Rather than use expensive state tracking, we can do something simpler. Like
Hansel and Gretel, we can leave breadcrumbs in the mempool as we traverse it,
so we can know if we are going somewhere we’ve already been. Luckily, in
bitcoind there are no birds!</p>

<p>These breadcrumbs are a uint64_t epoch per CTxMemPoolEntry. (64 bits is enough
that it will never overflow). The mempool also has a counter.</p>

<p>Every time we begin traversing the mempool, and we need some help tracking
state, we increment the mempool’s counter. Any CTxMemPoolEntry with an epoch
less than the MemPools has not yet been touched, and should be traversed and
have it’s epoch set higher.</p>

<p>Given the one-to-one mapping between CTxMemPool entries and transactions, this
is a safe way to cache data.</p>

<p>Using these bread-crumbs allows us to get rid of many of the std::set
accumulators in favor of a std::vector as we no longer rely on the
de-duplicative properties of std::set.</p>

<p>We can also improve many of the related algorithms to no longer make heavy use
of heapstack based processing.</p>

<p><a href="https://github.com/bitcoin/bitcoin/projects/14#card-31846646">Keep up on the Epoch Mempool progress.</a></p>

</div>



        </div>
        <div class="content container" style="padding-bottom:0;padding-top:0;bottom:0px;">
            <div class="posts" style="height:14pt;margin-bottom:0;">
                <div class="post">
                    <p style="text-align:center;font-size:12pt;">&copy; 2011-2021 Jeremy Rubin. All rights reserved.</p>
                </div>
            </div>
        </div>
    </body>
</html>

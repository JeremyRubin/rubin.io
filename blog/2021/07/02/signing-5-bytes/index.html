<!DOCTYPE html>
<html lang="en-us">
    <head>
  <title> CheckSigFromStack for 5 Byte Values &middot; Jeremy Rubin </title>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#c08a3a">
  <meta name="color-scheme" content="dark">


  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/font-awesome-4.5.0/css/font-awesome.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap">
  <link rel="stylesheet" href="/public/css/jr-2026.css">
  
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="icon" type="image/svg+xml" href="/public/favicon.svg">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  











<meta name="description" content="I recently published a blog post about covenants on Bitcoin. Readers were quick to point out I hadn’t fully explained myself on a claim I made that you can d...">
<meta name="author" content="Jeremy Rubin">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://rubin.io/blog/2021/07/02/signing-5-bytes/">
<meta property="og:title" content="CheckSigFromStack for 5 Byte Values - Jeremy Rubin">
<meta property="og:description" content="I recently published a blog post about covenants on Bitcoin. Readers were quick to point out I hadn’t fully explained myself on a claim I made that you can d...">
<meta property="og:type" content="article">
<meta property="og:url" content="https://rubin.io/blog/2021/07/02/signing-5-bytes/">
<meta property="og:site_name" content="Jeremy Rubin">
<meta property="og:locale" content="en_US">

<meta property="og:image" content="https://rubin.io/public/img/jeremy.jpg">

<meta name="twitter:card" content="summary_large_image">

<meta name="twitter:image" content="https://rubin.io/public/img/jeremy.jpg">


<meta name="twitter:site" content="@JeremyRubin">
<meta name="twitter:creator" content="@JeremyRubin">


<meta property="article:published_time" content="2021-07-02T00:00:00+00:00">

<link rel="sitemap" type="application/xml" href="https://rubin.io/sitemap.xml">
<link type="application/atom+xml" rel="alternate" href="https://rubin.io/feed.xml" title="Jeremy Rubin" />
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Jeremy Rubin",
  "url": "https://rubin.io/",
  "description": "Bitcoin research, smart contracts, and applied cryptography."
}
</script>


  
<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LF6VBT5B2T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LF6VBT5B2T');
</script>


  

  <link rel="me" href="https://twitter.com/JeremyRubin">



</head>

    <body>
        <a class="skip-link" href="#main">Skip to content</a>
        <header class="site-header">
    <div class="header-inner">
        <div class="brand">
            <a class="brand-mark" href="/">JR</a>
            <div class="brand-text">
                <a class="brand-name" href="/">Jeremy Rubin</a>
                
                <span class="brand-tagline">Bitcoin research, smart contracts, and applied cryptography.</span>
                
            </div>
        </div>
        <nav class="site-nav">
            <a class="nav-link" href="/">Home</a>
            <a class="nav-link" href="/blog/">Blog</a>
            <a class="nav-link" href="/talks/">Talks</a>
            <a class="nav-link" href="/projects/">Projects</a>
            <a class="nav-link" href="/archive/">Site Index</a>
        </nav>
        <div class="site-actions">
            
            <a class="icon-button" href="/public/pdfs/resume.pdf" aria-label="Resume">
                <i class="fa fa-file-text-o" aria-hidden="true"></i>
            </a>
            
            
            
            <a class="icon-button" href="https://twitter.com/JeremyRubin" aria-label="Twitter">
                <i class="fa fa-twitter" aria-hidden="true"></i>
            </a>
            
        </div>
    </div>
</header>

        <main id="main" class="content container">
            <article class="post">
    <header class="post-header">
        <h1 class="post-title">CheckSigFromStack for 5 Byte Values</h1>
        
        
        <span class="post-date">02 Jul 2021</span>
    </header>
    <div class="post-body">
        <p>I recently published <a href="https://rubin.io/blog/2021/07/02/covenants/">a blog post</a>
about covenants on Bitcoin.</p>

<p>Readers were quick to point out I hadn’t
fully explained myself on a claim I made that you can do a form of
CheckSigFromStack in Bitcoin today.</p>

<p>So I thought it would be worthwhile to fully describe the technique – for the
archives.</p>

<p>There are two insights in this post:</p>

<ol>
  <li>to use a bitwise expansion of the number</li>
  <li>to use a lamport signature</li>
</ol>

<p>Let’s look at the code in python and then translate to bitcoin script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">preimage</span><span class="p">,</span> <span class="n">image_0</span><span class="p">,</span> <span class="n">image_1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">preimage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">image_1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">image_0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">get_signed_number</span><span class="p">(</span><span class="n">witnesses</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Hash</span><span class="p">],</span> <span class="n">keys</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Hash</span><span class="p">,</span> <span class="n">Hash</span><span class="p">]]):</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">preimage</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">witnesses</span><span class="p">):</span>
        <span class="n">acc</span> <span class="o">+=</span> <span class="n">add_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">preimage</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<p>So what’s going on here? The signer generates a key which is a list of pairs of
hash images to create the script.</p>

<p>To sign, the signer provides a witness of a list of preimages that match one or the other.</p>

<p>During validation, the network adds up a weighted value per preimage and checks
that there are no left out values.</p>

<p>Let’s imagine a concrete use case: I want a third party to post-hoc sign a sequence lock. This is 16 bits.
I can form the following script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;pk&gt; checksigverify
0
SWAP sha256 DUP &lt;H(K_0_1)&gt; EQUAL IF DROP &lt;1&gt; ADD ELSE &lt;H(K_0_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_1_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;1&gt; ADD ELSE &lt;H(K_1_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_2_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;2&gt; ADD ELSE &lt;H(K_2_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_3_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;3&gt; ADD ELSE &lt;H(K_3_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_4_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;4&gt; ADD ELSE &lt;H(K_4_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_5_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;5&gt; ADD ELSE &lt;H(K_5_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_6_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;6&gt; ADD ELSE &lt;H(K_6_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_7_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;7&gt; ADD ELSE &lt;H(K_7_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_8_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;8&gt; ADD ELSE &lt;H(K_8_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_9_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;9&gt; ADD ELSE &lt;H(K_9_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_10_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;10&gt; ADD ELSE &lt;H(K_10_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_11_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;11&gt; ADD ELSE &lt;H(K_11_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_12_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;12&gt; ADD ELSE &lt;H(K_12_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_13_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;13&gt; ADD ELSE &lt;H(K_13_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_14_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;14&gt; ADD ELSE &lt;H(K_14_0)&gt; EQUALVERIFY ENDIF
SWAP sha256 DUP &lt;H(K_15_1)&gt; EQUAL IF DROP &lt;1&lt;&lt;15&gt; ADD ELSE &lt;H(K_15_0)&gt; EQUALVERIFY ENDIF
CHECKSEQUENCEVERIFY
</code></pre></div></div>

<p>In order to sign a 16 bit value V, the owner of K simply puts on the stack the
binary representation of V indexed into the K. E.g., to sign <code class="language-plaintext highlighter-rouge">53593</code>, first
expand to binary <code class="language-plaintext highlighter-rouge">0b1101000101011001</code>, then put the appropriate K values on the
stack.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>K_15_1
K_14_1
K_13_0
K_12_1
K_11_0
K_10_0
K_9_0
K_8_1
K_7_0
K_6_1
K_5_0
K_4_1
K_3_1
K_2_0
K_1_0
K_0_1
&lt;sig&gt;
</code></pre></div></div>

<p>This technique is kind of bulky! It’s around 80x16 = 1280 length for the
gadget, and 528 bytes for the witnesses. So it is <em>doable</em>, if not a bit
expensive. There might be some more efficient scripts for this – would a
trinary representation be more efficient?</p>

<p>The values that can be signed can be range limited either post-hoc (using
OP_WITHIN) or internally as was done with the 16 bit value circuit where it’s
impossible to do more than 16 bits.</p>

<p>Keys <em>can</em> be reused across scripts, but signatures may only be constructed one
time because a third party could take two signed messages and construct an
unintended value (e.g., if you sign both 4 and 2 then a third party could
construct 6).</p>

<p>There are certain applications where this could be used for an effect – for
example, an oracle might have a bonding contract whereby posessing any K_i_0
and K_i_1 allows the burning of funds.</p>

    </div>

    
    
    

    <div class="post-footer">
        <h3>Share this post</h3>
        <div class="post-share">
            




<div class="share-bar" role="list">
  <a class="share-button" role="listitem"
    href="https://twitter.com/intent/tweet?text=CheckSigFromStack+for+5+Byte+Values&url=https%3A%2F%2Frubin.io%2Fblog%2F2021%2F07%2F02%2Fsigning-5-bytes%2F"
    target="_blank" rel="noopener">Twitter</a>
  <a class="share-button" role="listitem"
    href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Frubin.io%2Fblog%2F2021%2F07%2F02%2Fsigning-5-bytes%2F&t=CheckSigFromStack%20for%205%20Byte%20Values" target="_blank"
    rel="noopener">HN</a>
  <a class="share-button" role="listitem"
    href="https://www.reddit.com/submit?url=https%3A%2F%2Frubin.io%2Fblog%2F2021%2F07%2F02%2Fsigning-5-bytes%2F&title=CheckSigFromStack+for+5+Byte+Values"
    target="_blank" rel="noopener">Reddit</a>
  <a class="share-button" role="listitem"
    href="mailto:?subject=CheckSigFromStack+for+5+Byte+Values&body=https%3A%2F%2Frubin.io%2Fblog%2F2021%2F07%2F02%2Fsigning-5-bytes%2F">Email</a>
  <a class="share-button" role="listitem"
    href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Frubin.io%2Fblog%2F2021%2F07%2F02%2Fsigning-5-bytes%2F" target="_blank"
    rel="noopener">LinkedIn</a>
</div>

        </div>
    </div>
</article>

<aside class="related">
  <h3>You might also enjoy...</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/talks/2026/02/02/2020-01-30-chaincode-3/">
          
          <small><time datetime="2026-02-02T00:01:12+00:00">02 Feb 2026</time></small>
        </a>
      </li>
    
      <li>
        <a href="/bitcoin/2025/05/04/delbrag-talk/">
          Grokking DelBrag: Out-of-Band On-Chain Fraud Proofs through Circuit Garbling @ Bitcoin++ Austin
          <small><time datetime="2025-05-04T00:00:00+00:00">04 May 2025</time></small>
        </a>
      </li>
    
      <li>
        <a href="/bitcoin/2025/04/04/delbrag/">
          Delbrag
          <small><time datetime="2025-04-04T00:00:00+00:00">04 Apr 2025</time></small>
        </a>
      </li>
    
  </ul>
</aside>


        </main>
        <footer class="site-footer">
            <div class="footer-inner">
                <p>&copy; 2011-2026 Jeremy Rubin. All rights reserved.</p>
                <a href="/atom.xml">RSS</a>
            </div>
        </footer>
    </body>
</html>
